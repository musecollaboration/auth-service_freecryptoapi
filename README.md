# Crypto API

## Описание проекта

Crypto API - это RESTful API, разработанный на Django REST Framework, предназначенный для создания основы приложения, работающего с криптовалютами. Ключевой особенностью проекта является реализация системы управления пользователями, которая обеспечивает надежную аутентификацию и авторизацию для будущих пользователей Crypto API. Проект включает в себя полный цикл управления пользовательскими аккаунтами, начиная от регистрации и заканчивая восстановлением пароля, что создает прочную базу для дальнейшего расширения функциональности, связанной с криптовалютными операциями.

## Основные функции

- Регистрация и аутентификация пользователей
- Подтверждение email при регистрации
- Функционал изменения и сброса пароля
- Аутентификация на основе JWT
- Ограничение частоты запросов (Rate limiting)
- Асинхронная обработка задач с использованием Celery
- Кэширование с использованием Redis
- Получение курсов криптовалют

## Структура проекта

Проект состоит из трех основных приложений:

1. **apps/accounts**: Управление пользователями и аутентификацией
2. **apps/common**: Общие утилиты и функции
3. **apps/crypto**: Функционал, связанный с криптовалютами

## Требования

- Python 3.x
- Django 5.2.3
- Django REST Framework
- Celery
- Redis
- SQLite (для разработки)
- RabbitMQ
- JWT (JSON Web Tokens)
- drf-spectacular (для документации API)

## Установка и настройка

1. Клонируйте репозиторий: git clone <URL репозитория> cd auth-service_freecryptoapi

2. Создайте и активируйте виртуальное окружение:

   - `python -m venv venv`
   - `source venv/bin/activate` # Для Unix-подобных систем
   - `venv\Scripts\activate` # Для Windows

3. Установите зависимости:
   `pip install -r requirements.txt`

4. Создайте файл `.env` в директории `core` и добавьте следующие переменные окружения:

   - SECRET_KEY=<ваш*секретный ключ>
   - EMAIL_HOST_PASSWORD=<пароль для почтового сервера>
   - COINGECKO_API_KEY=<API ключ coingecko>
   

5. Примените миграции:
   `python manage.py migrate`

6. Создайте суперпользователя:
   `python manage.py createsuperuser`

7. Запустите сервер разработки:
   `python manage.py runserver`

8. Запустите Celery worker:
   `celery -A core worker -l info`

9. Запустите Celery beat для периодических задач:
   `celery -A core beat -l info`

## Структура проекта

```bash
auth-service_freecryptoapi/
│
├── core/
│   ├── __init__.py
│   ├── .env              # Файл с переменными окружения (не включается в репозиторий)
│   ├── asgi.py
│   ├── celery.py         # Конфигурация Celery
│   ├── settings.py       # Настройки проекта
│   ├── urls.py           # Основные URL-маршруты
│   └── wsgi.py
│
├── apps/
│   ├── accounts/
│   │   ├── migrations/
│   │   ├── __init__.py
│   │   ├── admin.py
│   │   ├── apps.py
│   │   ├── managers.py    # Кастомные менеджеры моделей
│   │   ├── models.py      # Модели пользователей
│   │   ├── serializers.py # Сериализаторы моделей
│   │   ├── signals.py     # Сигналы Django
│   │   ├── tasks.py       # Задачи Celery
│   │   ├── tests.py       # Тесты моделей
│   │   ├── urls.py        # URL-маршруты аутентификации
│   │   ├── utils.py       # Вспомогательные функции
│   │   └── views.py       # Представления аутентификации
│   │
│   ├── common/
│   │   ├── migrations/
│   │   ├── __init__.py
│   │   ├── admin.py
│   │   ├── apps.py
│   │   ├── models.py
│   │   └── tests.py
│   │
│   └── crypto/
│       ├── migrations/
│       ├── services/
│       │   ├── __init__.py
│       │   ├── debug_utils.py  # Вспомогательные функции для отладки
│       │   ├── rabbitmq.py     # Утилиты для работы с RabbitMQ
│       │   ├── redis.py        # Утилиты для работы с Redis
│       │   └── tasks.py        # Задачи Celery для криптовалют
│       ├── __init__.py
│       ├── admin.py
│       ├── apps.py
│       ├── models.py
│       ├── serializers.py     # Сериализаторы моделей
│       ├── tests.py
│       ├── urls.py       # URL-маршруты для криптовалют
│       └── views.py      # Представления для криптовалют
│
├── venv/                 # Виртуальное окружение (не включается в репозиторий)
│
├── .gitignore
├── manage.py
├── README.md
└── requirements.txt
```

## API Endpoints

### Аутентификация

1. Регистрация: `POST /api/v1/auth/register/`    
2. Получение токена: `POST /api/v1/auth/token/`
3. Обновление токена: `POST /api/v1/auth/token/refresh/`
4. Подтверждение email: `GET /api/v1/auth/verify-email/`
5. Смена пароля: `PATCH /api/v1/auth/change-password/`
6. Запрос на сброс пароля: `POST /api/v1/auth/reset-password/`
7. Подтверждение сброса пароля: `POST /api/v1/auth/reset-password-confirm/`

### Криптовалюты

1. Получение курса криптовалюты: GET /api/v1/crypto/<symbol>/

## Теги для документации и API

Документация API доступна по адресу `/api/schema/swagger-ui/` после запуска сервера разработки.
`@extend_schema`: Для расширения схемы API в drf-spectacular

## Особенности реализации

1. Пользовательская модель:
   Используется кастомная модель пользователя с email в качестве идентификатора.
   Реализован CustomUserManager для управления пользователями.
   Модель включает поля для верификации email и управления статусом пользователя.

2. JWT-аутентификация:
   Используется rest_framework_simplejwt для работы с JWT-токенами.
   Настроена кастомная конфигурация JWT в settings.py для управления временем жизни токенов.
   Реализован MyTokenObtainPairSerializer для кастомизации payload токена.

3. Подтверждение email:
   При регистрации отправляется email с ссылкой для подтверждения.
   Используется асинхронная отправка email через Celery для улучшения производительности.
   Реализован механизм генерации и проверки токенов для подтверждения email.

4. Асинхронные задачи:
   Celery используется для отправки email и других фоновых задач.
   Настроены периодические задачи с использованием Celery Beat.
   Реализованы задачи для обновления курсов криптовалют в фоновом режиме.

5. Ограничение запросов:
   Используется django-ratelimit для ограничения количества запросов.
   Настроены различные лимиты для разных эндпоинтов API.
   Реализована кастомная конфигурация для хранения данных о лимитах в Redis.

6. Кэширование:
   Redis используется для кэширования и в качестве брокера сообщений для Celery.
   Реализовано кэширование курсов криптовалют для оптимизации запросов к внешним API.
   Настроено кэширование результатов выполнения Celery-задач.

7. API документация:
   Используется drf-spectacular для автоматической генерации документации API.
   Настроена кастомная конфигурация Swagger UI в settings.py.
   Добавлены детальные описания для каждого эндпоинта с использованием декоратора @extend_schema.

8. Интеграция с внешними сервисами:
   Реализована интеграция с CoinGecko API для получения актуальных курсов криптовалют.
   Использование RabbitMQ для организации очередей сообщений между микросервисами.

9. Безопасность:
   Реализована защита от CSRF-атак с использованием токенов.
   Настроена защита от XSS-атак через соответствующие заголовки HTTP.
   Используется механизм хеширования паролей с применением алгоритма PBKDF2.

10. Масштабируемость:
    Проект структурирован с учетом возможности легкого добавления новых микросервисов.
    Использование Docker для контейнеризации приложения и упрощения процесса развертывания.

## Безопасность

- Используется HTTPS (необходимо настроить при деплое)
- Пароли хешируются с использованием алгоритма PBKDF2
- Реализовано ограничение количества запросов для предотвращения атак
- Секретные ключи и пароли хранятся в переменных окружения

## Тестирование

Для запуска тестов используйте команду:
`python manage.py test`

## Деплой

При деплое на продакшен необходимо:

1. Изменить `DEBUG = False` в `settings.py`
2. Настроить HTTPS
3. Использовать более надежную БД (например, PostgreSQL)
4. Настроить CORS
5. Обновить `ALLOWED_HOSTS` и `SITE_URL` в `settings.py`

## Контакты

Александр Терехов - [@musecollaboration](https://t.me/musecollaboration)
